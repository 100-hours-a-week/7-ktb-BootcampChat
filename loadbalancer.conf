# ğŸš€ HAProxy ê·¹í•œ ì„±ëŠ¥ ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì •
global
    maxconn 100000          # 10ë§Œ ë™ì‹œ ì—°ê²°
    nbthread 4              # 4ê°œ ìŠ¤ë ˆë“œ (t3.small 2 vCPU Ã— 2)
    tune.ssl.default-dh-param 2048
    
defaults
    mode http
    timeout connect 1s      # ë¹ ë¥¸ ì—°ê²°
    timeout client 10s      # í´ë¼ì´ì–¸íŠ¸ íƒ€ì„ì•„ì›ƒ
    timeout server 5s       # ì„œë²„ íƒ€ì„ì•„ì›ƒ
    option httplog
    option dontlognull
    option redispatch       # ì„œë²„ ì¥ì• ì‹œ ì¬ë¶„ë°°
    retries 2               # 2ë²ˆ ì¬ì‹œë„
    maxconn 50000          # ê¸°ë³¸ ìµœëŒ€ ì—°ê²°

# ğŸ–¥ï¸ ë°±ì—”ë“œ ì„œë²„ í’€ (15ê°œ ì¸ìŠ¤í„´ìŠ¤)
backend chat_backend
    balance roundrobin      # ë¼ìš´ë“œë¡œë¹ˆ ë¶„ì‚°
    option httpchk GET /api/health  # í—¬ìŠ¤ì²´í¬
    
    # 15ê°œ ë°±ì—”ë“œ ì„œë²„ (ê°ê° t3.small)
    server backend01 10.0.1.10:5000 check maxconn 3000
    server backend02 10.0.1.11:5000 check maxconn 3000
    server backend03 10.0.1.12:5000 check maxconn 3000
    server backend04 10.0.1.13:5000 check maxconn 3000
    server backend05 10.0.1.14:5000 check maxconn 3000
    server backend06 10.0.1.15:5000 check maxconn 3000
    server backend07 10.0.1.16:5000 check maxconn 3000
    server backend08 10.0.1.17:5000 check maxconn 3000
    server backend09 10.0.1.18:5000 check maxconn 3000
    server backend10 10.0.1.19:5000 check maxconn 3000
    server backend11 10.0.1.20:5000 check maxconn 3000
    server backend12 10.0.1.21:5000 check maxconn 3000
    server backend13 10.0.1.22:5000 check maxconn 3000
    server backend14 10.0.1.23:5000 check maxconn 3000
    server backend15 10.0.1.24:5000 check maxconn 3000

# ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ ì„¤ì •
frontend chat_frontend
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/chat.pem
    redirect scheme https if !{ ssl_fc }
    
    # ğŸš€ ì„±ëŠ¥ ìµœì í™”
    option httplog
    option forwardfor
    
    # API ìš”ì²­ ë¶„ì‚°
    acl is_api path_beg /api
    use_backend chat_backend if is_api
    
    # WebSocket ì—°ê²° (Sticky Session)
    acl is_websocket hdr(Upgrade) -i websocket
    use_backend chat_backend if is_websocket

# ğŸ“Š í†µê³„ í˜ì´ì§€
listen stats
    bind *:8080
    stats enable
    stats uri /stats
    stats refresh 10s 